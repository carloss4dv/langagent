@startuml RecuperacionRAG
!theme plain
!define DIRECTION left to right direction
title FASE DE RECUPERACIÃ“N - ÃMBITO AGENT COMO ENTRY POINT DEL SISTEMA

start

partition "ğŸ¯ ÃMBITO AGENT" {
  :ğŸ¯ **ENTRY POINT**
  @ambito_agent.py
  
  INPUT: question str;
  note right
    â€¢ create_ambito_workflow()
    â€¢ identify_ambito()
    â€¢ AMBITOS_CUBOS mapping
    â€¢ confidence scoring
  end note
  
  :ğŸ” Analyze Question
  Keywords + Patterns;
  
  if (confidence >= 0.7?) then (NO)
    :ğŸ“‘ Retrieve Context
    from VectorStore;
  endif
  
  if (needs clarification?) then (YES)
    :ğŸ’¬ Generate Clarification
    Question;
    :â†©ï¸ **RETURN TO USER**
    "Â¿En quÃ© Ã¡mbito...?";
    :ğŸ‘¤ **USER RESPONDS**
    with clarification;
    :ğŸ”„ **RE-PROCESS**
    with new context;
  endif
  
  :ğŸ“‹ **ÃMBITO STATE**
  Complete;
  note right
    **OUTPUT**:
    â€¢ ambito: "sostenibilidad"
    â€¢ cubos: ["energia", "residuos"]
    â€¢ confidence: 0.85
    â€¢ is_consulta: bool
    â€¢ came_from_clarification: bool
  end note
}

partition "ğŸ”„ WORKFLOW PRINCIPAL" {
  :ğŸ”„ **WORKFLOW ENTRY**
  @workflow.py
  
  Receives AmbitoState;
  
  if (came_from_clarification?) then (YES)
    :âœï¸ **QUERY REWRITING**
    with Ãmbito Context;
    note right
      **MEJORA CON ÃMBITO**:
      â€¢ Uses Ã¡mbito context
      â€¢ SEGEDA technical terms
      â€¢ LLM: mistral-small-3.1:24b
    end note
  endif
  
  :ğŸ” **RETRIEVE DOCUMENTS**
  **WITH ÃMBITO FILTERS**;
  note right
    **SIN ÃMBITO**:
    retriever.invoke(question)
    
    **CON ÃMBITO** (MEJORA):
    retriever.invoke(question, 
      filters={"ambito": "sostenibilidad"})
    
    **RESULTADO**: Documentos mÃ¡s relevantes
  end note
  
  :ğŸ“Š **GRADE RELEVANCE**
  Context-Aware Evaluation;
  note right
    **EVALUACIÃ“N MEJORADA**:
    â€¢ Considers specific Ã¡mbito
    â€¢ Evaluates by relevant cubos
    â€¢ Domain-specific filtering
    â€¢ LLM: llama3.2:3bm
  end note
  
  :ğŸ“‘ **FINAL DOCUMENTS**
  Enriched with Ãmbito;
  note right
    **OUTPUT ENRIQUECIDO**:
    â€¢ retrieved_documents: List[Document]
    â€¢ ambito: "sostenibilidad" (preserved)
    â€¢ cubos: ["energia", "residuos"] (applied)
    â€¢ domain_context: complete
    **READY FOR GENERATION**
  end note
}

stop

@enduml 