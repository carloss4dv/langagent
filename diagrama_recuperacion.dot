digraph RecuperacionRAG {
    // ConfiguraciÃ³n general para layout horizontal
    rankdir=LR;
    ranksep=1.5;
    nodesep=0.8;
    splines=ortho;
    
    // Estilos de nodos
    node [fontname="Arial", fontsize=10, margin=0.1];
    edge [fontname="Arial", fontsize=9];
    
    // NIVEL 1: Entrada del usuario
    {rank=same; usuario}
    usuario [shape=box, style="rounded,filled", fillcolor="#E3F2FD", 
             label="ðŸ‘¤ CONSULTA USUARIO\nâ€¢ question: str\nâ€¢ came_from_clarification: bool"];
    
    // NIVEL 2: Punto de entrada condicional
    {rank=same; entry_point}
    entry_point [shape=diamond, style="filled", fillcolor="#FFF3E0",
                 label="ðŸ”„ ENTRY POINT\nÂ¿came_from_clarification?"];
    
    // NIVEL 3: Query rewriting (condicional)
    {rank=same; rewrite_query, retrieve_direct}
    rewrite_query [shape=box, style="rounded,filled", fillcolor="#F3E5F5",
                   label="âœï¸ QUERY REWRITING\nâ€¢ LLM: mistral-small-3.1:24b\nâ€¢ temperature: 0.15\nâ€¢ max_tokens: 2048\nâ€¢ TÃ©rminos tÃ©cnicos SEGEDA"];
    
    retrieve_direct [shape=point, style=invis];
    
    // NIVEL 4: RecuperaciÃ³n de documentos
    {rank=same; retrieve}
    retrieve [shape=box, style="rounded,filled", fillcolor="#E8F5E8",
              label="ðŸ” RETRIEVE DOCUMENTS\nâ€¢ Estrategia actual: chunk_strategy\nâ€¢ Retriever adaptativo activo\nâ€¢ Vector DB: Milvus/Zilliz\nâ€¢ Filtros por Ã¡mbito/cubo"];
    
    // NIVEL 5: Configuraciones y parÃ¡metros (subgrafos paralelos)
    {rank=same; config_retrieval, strategies, vectorstore, ambitos}
    
    config_retrieval [shape=record, style="filled", fillcolor="#FFFDE7",
                      label="ðŸ“‹ CONFIGURACIÃ“N RETRIEVAL\nâ€¢ k_retrieval: 6\nâ€¢ max_docs_total: 15\nâ€¢ similarity_threshold: 0.7\nâ€¢ chunk_overlap: 50\nâ€¢ use_adaptive_retrieval: bool"];
    
    strategies [shape=record, style="filled", fillcolor="#FFF8E1",
                label="ðŸ“ ESTRATEGIAS CHUNK\nâ€¢ 256 tokens: PrecisiÃ³n alta\nâ€¢ 512 tokens: Balance Ã³ptimo\nâ€¢ 1024 tokens: Contexto amplio\nâ€¢ DEFAULT_CHUNK_STRATEGY"];
    
    vectorstore [shape=record, style="filled", fillcolor="#F1F8FF",
                 label="ðŸ—„ï¸ VECTOR STORE\nâ€¢ Type: Milvus/Zilliz Cloud\nâ€¢ URI: cloud endpoint\nâ€¢ Token: secure auth\nâ€¢ Hybrid search: true\nâ€¢ Single collection: true"];
    
    ambitos [shape=record, style="filled", fillcolor="#F0FFF0",
             label="ðŸŽ¯ ÃMBITOS SEGEDA\nâ€¢ AMBITOS_CUBOS mapping\nâ€¢ CUBO_TO_AMBITO dict\nâ€¢ AMBITO_KEYWORDS\nâ€¢ find_relevant_cubos_by_keywords()"];
    
    // NIVEL 6: EvaluaciÃ³n de relevancia
    {rank=same; grade_relevance}
    grade_relevance [shape=box, style="rounded,filled", fillcolor="#FDF2F8",
                     label="ðŸ“Š GRADE RELEVANCE\nâ€¢ LLM: llama3.2:3bm\nâ€¢ BYPASS_GRADING: configurable\nâ€¢ Filtro conservativo\nâ€¢ Error handling robusto"];
    
    // NIVEL 7: Salida
    {rank=same; output}
    output [shape=box, style="rounded,filled", fillcolor="#F0F9FF",
            label="ðŸ“‘ DOCUMENTOS RELEVANTES\nâ€¢ retrieved_documents: List[Document]\nâ€¢ retrieval_details: Dict\nâ€¢ relevant_count: int\nâ€¢ chunk_strategy aplicada"];
    
    // Conexiones principales
    usuario -> entry_point;
    entry_point -> rewrite_query [label="true"];
    entry_point -> retrieve_direct [label="false", style=invis];
    retrieve_direct -> retrieve [style=invis];
    rewrite_query -> retrieve;
    retrieve -> grade_relevance;
    grade_relevance -> output;
    
    // Conexiones de configuraciÃ³n (punteadas)
    retrieve -> config_retrieval [style=dashed, color=gray];
    retrieve -> strategies [style=dashed, color=gray];
    retrieve -> vectorstore [style=dashed, color=gray];
    retrieve -> ambitos [style=dashed, color=gray];
    
    // Etiquetas de flujo
    entry_point -> rewrite_query [label="Si viene de\nclarificaciÃ³n"];
    entry_point -> retrieve [label="Consulta directa", constraint=false];
    
    // TÃ­tulo del diagrama
    labelloc="t";
    label="FASE DE RECUPERACIÃ“N - SISTEMA RAG ADAPTATIVO CON MÃšLTIPLES ESTRATEGIAS";
    fontsize=14;
    fontname="Arial Bold";
} 